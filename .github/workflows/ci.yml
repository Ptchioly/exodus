name: CI
on:
  push:
    branches: 
      - 'main'
    tags:
      - 'v*.*.*'
jobs:
  setup-and-run-ui-tests:
    name: Run UI Tests - Chrome
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.1
        with:
          fetch-depth: 0
      - name: UI Tests - Chrome
        uses: cypress-io/github-action@v2
        with:
          config: 'baseUrl=http://localhost:5000'
          # config: 'viewportWidth=375,viewportHeight=812,baseUrl=http://localhost:5000'
          start: npm run frontend:start, npm run backend:start
          wait-on: 'http://localhost:5000, http://localhost:8081/logout'
          wait-on-timeout: 120
          browser: chrome
          headless: true
          working-directory: tests
          group: 'UI - Chrome'
          record: true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

  restart-server:
    name: Connect with SSH and Restart Server
    runs-on: ubuntu-latest
    needs: setup-and-run-ui-tests
    steps:
      - name: Configure SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/main.key
          chmod 600 ~/.ssh/main.key
          cat >>~/.ssh/config <<END
          Host main
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/main.key
            StrictHostKeyChecking no
          END
        env:
          SSH_USER: ${{ secrets.SERVER_USERNAME }}
          SSH_KEY: ${{ secrets.SERVER_KEY }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}

      - name: Restart Server
        shell: bash
        run: ssh main 'cd exodus/backend && git fetch && git checkout main && git pull && npm ci && npm run build && sudo forever stopall && sudo forever start out/app.js'


  deploy:
      name: Deploy
      needs: restart-server
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2.3.1 # If you're using actions/checkout@v2 you must set persist-credentials to false in most cases for the deployment to work correctly.
          with:
            # persist-credentials: false
            fetch-depth: 0
        - name: Install and Build
          run: |
            cd ./frontend
            npm ci
            npm run build

        - name: Prepare Tag
          id: prepare_tag
          if: startsWith(github.ref, 'refs/tags/')
          run: |
            TAG_NAME="${GITHUB_REF##refs/tags/}"
            echo "::set-output name=tag_name::${TAG_NAME}"
            echo "::set-output name=deploy_tag_name::deploy-${TAG_NAME}"
    
        - name: Deploy
          uses: peaceiris/actions-gh-pages@v3
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./public
            tag_name: ${{ steps.prepare_tag.outputs.deploy_tag_name }}
            tag_message: 'Deployment ${{ steps.prepare_tag.outputs.tag_name }}'
            user_name: 'exodus[bot]'
            user_email: 'exodus[bot]@exodus.noreply.github.com'
            commit_message: ${{ github.event.head_commit.message }}
     